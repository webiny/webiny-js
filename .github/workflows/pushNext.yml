# This file was automatically generated by github-actions-wac.
# DO NOT MODIFY IT BY HAND. Instead, modify the source *.wac.ts file(s)
# and run "github-actions-wac build" (or "ghawac build") to regenerate this file.
# For more information, run "github-actions-wac --help".
name: Next Branch - Push
'on':
  push:
    branches:
      - next
jobs:
  constants:
    name: Create constants
    outputs:
      global-cache-key: ${{ steps.global-cache-key.outputs.global-cache-key }}
      run-cache-key: ${{ steps.run-cache-key.outputs.run-cache-key }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
      - name: Create global cache key
        id: global-cache-key
        run: >-
          echo "global-cache-key=next-${{ runner.os }}-$(/bin/date -u
          "+%m%d")-${{ vars.RANDOM_CACHE_KEY_SUFFIX }}" >> $GITHUB_OUTPUT
      - name: Create workflow run cache key
        id: run-cache-key
        run: >-
          echo "run-cache-key=${{ github.run_id }}-${{ github.run_attempt }}-${{
          vars.RANDOM_CACHE_KEY_SUFFIX }}" >> $GITHUB_OUTPUT
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: false
  build:
    name: Build
    needs: constants
    runs-on: webiny-build-packages
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
        with:
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.global-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages
        run: yarn build:quick
        working-directory: next
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: false
  codeAnalysis:
    name: Static code analysis
    needs:
      - constants
      - build
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
        with:
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Check code formatting
        run: yarn prettier:check
        working-directory: next
      - name: Check dependencies
        run: yarn adio
        working-directory: next
      - name: Check TS configs
        run: yarn check-ts-configs
        working-directory: next
      - name: ESLint
        run: yarn eslint
        working-directory: next
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: false
  staticCodeAnalysisTs:
    name: Static code analysis (TypeScript)
    runs-on: webiny-build-packages
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
        with:
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages (full)
        run: yarn build
        working-directory: next
      - name: Check types for Cypress tests
        run: yarn cy:ts
        working-directory: next
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: false
  jestTestsNoStorage:
    needs:
      - constants
      - build
    name: ${{ matrix.package.cmd }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
        node:
          - 20
        package: >-
          ${{
          fromJson('[{"cmd":"packages/api","id":"806497aaa729e8d39f59792bcfb12b26"},{"cmd":"packages/api-admin-settings","id":"31140e7ea9283c9db32ec5f905ce2a1e"},{"cmd":"packages/api-authentication","id":"0eaf9f853f122e4ab215bf49d39f3edc"},{"cmd":"packages/api-authentication-cognito","id":"dfb5e1fcea213538a9730314cb5e7d06"},{"cmd":"packages/api-headless-cms-ddb","id":"5333e1fe6c2b8f5bbcb101a446419c3e"},{"cmd":"packages/api-record-locking","id":"9340c019a5369ea1aa55f7ed28b09f48"},{"cmd":"packages/api-wcp","id":"77ff8a0a075e8d9f7e25001ea64c6c9e"},{"cmd":"packages/api-websockets","id":"fd704b97c31f78a886b342babd344d33"},{"cmd":"packages/app-aco","id":"dddb66beffe2e54804d5bdedd2b423cb"},{"cmd":"packages/app-admin","id":"53bbef747a26e831904585bcfdd845f7"},{"cmd":"packages/cwp-template-aws","id":"846572f41c9427974a577bb95257d019"},{"cmd":"packages/data-migration","id":"294257fffed0174f169b2c812e16258e"},{"cmd":"packages/db-dynamodb","id":"5cb733de265d7bbda981fce60f2a8962"},{"cmd":"packages/form","id":"5707e699d8a4d3b8ee1954c070a50617"},{"cmd":"packages/handler","id":"1dad17bbf61657b4308250e8293cb5dd"},{"cmd":"packages/handler-aws","id":"2a5bd44c5f2a4290c43f9021bbc705a5"},{"cmd":"packages/handler-graphql","id":"74884166fb2bf383da482fb78b18b704"},{"cmd":"packages/handler-logs","id":"ca9a7e2ed32de50aff66c839f0003352"},{"cmd":"packages/ioc","id":"af22b6d7d245321d64d4b714d03ef3e1"},{"cmd":"packages/lexical-converter","id":"52e3bb3ea633bd27d5bab8be976cd16f"},{"cmd":"packages/plugins","id":"c91537eaa40845d816d0d9f39e66018b"},{"cmd":"packages/pubsub","id":"fc14c28c51c537a7d9edd33d73ae29e2"},{"cmd":"packages/react-composition","id":"428b8a3187fe275cb76da6bad0ba3918"},{"cmd":"packages/react-properties","id":"7578e63dcaa1ac66fed4a8dd936a9285"},{"cmd":"packages/react-rich-text-lexical-renderer","id":"452451b34eb7e0134e99b0706e5eb076"},{"cmd":"packages/utils","id":"696ceb17e38e4a274d4a149d24513b78"},{"cmd":"packages/validation","id":"9c68da33792a1214ae45e040a2830cd7"}]')
          }}
    runs-on: ${{ matrix.os }}
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: false
      AWS_REGION: eu-central-1
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
        with:
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages
        run: yarn build:quick
        working-directory: next
      - name: Run tests
        run: yarn test ${{ matrix.package.cmd }}
        working-directory: next
  jestTestsDdb:
    needs:
      - constants
      - build
    name: ${{ matrix.package.cmd }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
        node:
          - 20
        package: >-
          ${{ fromJson('[{"cmd":"packages/api-aco
          --storage=ddb","storage":"ddb","id":"5595b4f3460fb2a019066177bd6489f3"},{"cmd":"packages/api-apw
          --storage=ddb","storage":"ddb","id":"04462239e1f3509b08f511de460971ec"},{"cmd":"packages/api-audit-logs
          --storage=ddb","storage":"ddb","id":"47680aa68a1a3951f1117c736e150e45"},{"cmd":"packages/api-file-manager
          --storage=ddb","storage":"ddb","id":"9b6eee1ff7cbf9a3d367818705cc4189"},{"cmd":"packages/api-form-builder
          --storage=ddb","storage":"ddb","id":"980a9aebb5ec0cab057422364a60493b"},{"cmd":"packages/api-headless-cms
          --storage=ddb
          --shard=1/6","storage":"ddb","id":"70476469f4407a455237133406a37a4b"},{"cmd":"packages/api-headless-cms
          --storage=ddb
          --shard=2/6","storage":"ddb","id":"0eba11dcf36fd00e737a630f40567e85"},{"cmd":"packages/api-headless-cms
          --storage=ddb
          --shard=3/6","storage":"ddb","id":"8c15e662d10ad6272ac557515e39d4cd"},{"cmd":"packages/api-headless-cms
          --storage=ddb
          --shard=4/6","storage":"ddb","id":"3b14c43cd5971ad2945b1f0e87970e20"},{"cmd":"packages/api-headless-cms
          --storage=ddb
          --shard=5/6","storage":"ddb","id":"a71716169299cfee9996f4344c84616f"},{"cmd":"packages/api-headless-cms
          --storage=ddb
          --shard=6/6","storage":"ddb","id":"26f0b825b771340ca981858d86bd1f42"},{"cmd":"packages/api-headless-cms-aco
          --storage=ddb","storage":"ddb","id":"718c110b004c59ed7d13cbcc875a6b64"},{"cmd":"packages/api-headless-cms-bulk-actions
          --storage=ddb","storage":"ddb","id":"00c0a57737502f28c304015d2d1ba442"},{"cmd":"packages/api-headless-cms-import-export
          --storage=ddb","storage":"ddb","id":"e9052e7c40171aeb43ce089fdfbbe3c8"},{"cmd":"packages/api-i18n
          --storage=ddb","storage":"ddb","id":"943e15fe21c847b164f9413f8baf97b7"},{"cmd":"packages/api-mailer
          --storage=ddb","storage":"ddb","id":"2cc1dc707a39e72f4e5d9a140677ca39"},{"cmd":"packages/api-page-builder
          --storage=ddb
          --shard=1/6","storage":"ddb","id":"b2a30dfaf230076ce7120c55eb581d32"},{"cmd":"packages/api-page-builder
          --storage=ddb
          --shard=2/6","storage":"ddb","id":"c58e2f120653e8bd68475c16de4434c5"},{"cmd":"packages/api-page-builder
          --storage=ddb
          --shard=3/6","storage":"ddb","id":"808cb2da8e70bf84a24de2ab7ed27c24"},{"cmd":"packages/api-page-builder
          --storage=ddb
          --shard=4/6","storage":"ddb","id":"6f95134a56bea87da59d4c7d56846d72"},{"cmd":"packages/api-page-builder
          --storage=ddb
          --shard=5/6","storage":"ddb","id":"918eb8cb9d4046da9d38962b12e8ace6"},{"cmd":"packages/api-page-builder
          --storage=ddb
          --shard=6/6","storage":"ddb","id":"45bc3d824b38bd2770f1d4ba357387f9"},{"cmd":"packages/api-page-builder-aco
          --storage=ddb","storage":"ddb","id":"48281621c024ae9bbd0f79da5f6f4867"},{"cmd":"packages/api-page-builder-import-export
          --storage=ddb","storage":"ddb","id":"8540085b59af85d1fd82b37b9e890704"},{"cmd":"packages/api-prerendering-service
          --storage=ddb","storage":"ddb","id":"a2831c88465244dc03f188f4a40e4d63"},{"cmd":"packages/api-security
          --storage=ddb","storage":"ddb","id":"0a065366763b713fb016c43ce21e77b9"},{"cmd":"packages/api-security-cognito
          --storage=ddb","storage":"ddb","id":"0787967fe56689618106e6c64e784bff"},{"cmd":"packages/api-serverless-cms
          --storage=ddb","storage":"ddb","id":"b660572a629aa6e9191829fe7bfd33cc"},{"cmd":"packages/api-tenancy
          --storage=ddb","storage":"ddb","id":"0c81e56d64e97e6b563965250f04ed34"},{"cmd":"packages/api-tenant-manager
          --storage=ddb","storage":"ddb","id":"4b93a028b8055553c3443a45b38079e9"},{"cmd":"packages/tasks
          --storage=ddb","storage":"ddb","id":"925ba761b5995e8a8b980c0789034b3c"}]')
          }}
    runs-on: ${{ matrix.os }}
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: false
      AWS_REGION: eu-central-1
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
        with:
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages
        run: yarn build:quick
        working-directory: next
      - name: Run tests
        run: yarn test ${{ matrix.package.cmd }}
        working-directory: next
  jestTestsDdbEs:
    needs:
      - constants
      - build
    name: ${{ matrix.package.cmd }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
        node:
          - 20
        package: >-
          ${{ fromJson('[{"cmd":"packages/api-aco
          --storage=ddb-es,ddb","storage":"ddb-es","id":"8f23ec33f547aa62236f5c71115688d6"},{"cmd":"packages/api-audit-logs
          --storage=ddb-es,ddb","storage":"ddb-es","id":"a292444cd9100f78d8fc196274393ea8"},{"cmd":"packages/api-dynamodb-to-elasticsearch
          --storage=ddb-es,ddb","storage":["ddb-es"],"id":"e2c325f0940ba5fb5a891a8cf74fca61"},{"cmd":"packages/api-elasticsearch","storage":["ddb-es","ddb-os"],"id":"430874606aeb8e8041b325955f9330e3"},{"cmd":"packages/api-elasticsearch-tasks
          --storage=ddb-es,ddb","storage":"ddb-es","id":"d81ad1d024a8746cc440e2e548770f8f"},{"cmd":"packages/api-file-manager
          --storage=ddb-es,ddb","storage":"ddb-es","id":"d6f293add4a252b96cbd770ab6e80557"},{"cmd":"packages/api-form-builder
          --storage=ddb-es,ddb","storage":"ddb-es","id":"3753bde0144d808eb15c755b7176386c"},{"cmd":"packages/api-form-builder-so-ddb-es
          --storage=ddb-es,ddb","storage":"ddb-es","id":"be1748722ce53a7383696bdc9aecb36e"},{"cmd":"packages/api-headless-cms
          --storage=ddb-es,ddb
          --shard=1/6","storage":"ddb-es","id":"c9e8cf197d213d99f54ae218b027db43"},{"cmd":"packages/api-headless-cms
          --storage=ddb-es,ddb
          --shard=2/6","storage":"ddb-es","id":"0db69460c7bcc2bd54f21ae32c2436a0"},{"cmd":"packages/api-headless-cms
          --storage=ddb-es,ddb
          --shard=3/6","storage":"ddb-es","id":"13763c404c6788aa580d8b9fa8f52239"},{"cmd":"packages/api-headless-cms
          --storage=ddb-es,ddb
          --shard=4/6","storage":"ddb-es","id":"795fb79efa47ed2c7b14b1601b03db21"},{"cmd":"packages/api-headless-cms
          --storage=ddb-es,ddb
          --shard=5/6","storage":"ddb-es","id":"775a20e72e2f9e3db4c119b08dca9858"},{"cmd":"packages/api-headless-cms
          --storage=ddb-es,ddb
          --shard=6/6","storage":"ddb-es","id":"d9e94bb347222577c3a3c8ea3cc41e47"},{"cmd":"packages/api-headless-cms-aco
          --storage=ddb-es,ddb","storage":"ddb-es","id":"873cd623b92712713e58e7dc6ddbe5d9"},{"cmd":"packages/api-headless-cms-bulk-actions
          --storage=ddb-es,ddb","storage":"ddb-es","id":"d57a9e2a64e475f4629a14f4e1130e78"},{"cmd":"packages/api-headless-cms-ddb-es
          --storage=ddb-es,ddb","storage":"ddb-es","id":"f64e01fd77d4d1c22803e1523560b07c"},{"cmd":"packages/api-headless-cms-es-tasks
          --storage=ddb-es,ddb","storage":["ddb-es"],"id":"f857b5e4a7381a7f10eadef6ec83d9e0"},{"cmd":"packages/api-headless-cms-import-export
          --storage=ddb-es,ddb","storage":"ddb-es","id":"fa2cbb7997de447c87e3f1b646008711"},{"cmd":"packages/api-mailer
          --storage=ddb-es,ddb","storage":"ddb-es","id":"ccc077215f734fbec817d90fdb04d423"},{"cmd":"packages/api-page-builder
          --storage=ddb-es,ddb
          --shard=1/6","storage":"ddb-es","id":"a9d5f7851f0b921677df8521ff899f86"},{"cmd":"packages/api-page-builder
          --storage=ddb-es,ddb
          --shard=2/6","storage":"ddb-es","id":"d6c00270cbcfa826dab79e8c703c9eb5"},{"cmd":"packages/api-page-builder
          --storage=ddb-es,ddb
          --shard=3/6","storage":"ddb-es","id":"b407ab6f87871e108480b0fa3bc17902"},{"cmd":"packages/api-page-builder
          --storage=ddb-es,ddb
          --shard=4/6","storage":"ddb-es","id":"9aa4fe8f6e30c49c501003a914b2ca5c"},{"cmd":"packages/api-page-builder
          --storage=ddb-es,ddb
          --shard=5/6","storage":"ddb-es","id":"a84a7bf736194196387f2959132abfdd"},{"cmd":"packages/api-page-builder
          --storage=ddb-es,ddb
          --shard=6/6","storage":"ddb-es","id":"02927f20dd60108bec8356b6dae55357"},{"cmd":"packages/api-page-builder-aco
          --storage=ddb-es,ddb","storage":"ddb-es","id":"d12985ec4dcdb80af419125d236a73d8"},{"cmd":"packages/api-page-builder-so-ddb-es
          --storage=ddb-es,ddb","storage":"ddb-es","id":"911289d4016adf351238298ce5b41ac8"},{"cmd":"packages/api-serverless-cms
          --storage=ddb-es,ddb","storage":"ddb-es","id":"3d8f52f5b779b9ded3d746716fed019f"},{"cmd":"packages/migrations","storage":["ddb-es","ddb-os"],"id":"bd6345274042973682dcf9af2706627d"},{"cmd":"packages/tasks
          --storage=ddb-es,ddb","storage":"ddb-es","id":"0c5cd8395d241e54e3488ffcc1c81c26"}]')
          }}
    runs-on: ${{ matrix.os }}
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: false
      AWS_REGION: eu-central-1
      AWS_ELASTIC_SEARCH_DOMAIN_NAME: ${{ secrets.AWS_ELASTIC_SEARCH_DOMAIN_NAME }}
      ELASTIC_SEARCH_ENDPOINT: ${{ secrets.ELASTIC_SEARCH_ENDPOINT }}
      ELASTIC_SEARCH_INDEX_PREFIX: ${{ matrix.package.id }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::726952677045:role/GitHubActionsWebinyJs
          aws-region: eu-central-1
      - uses: actions/checkout@v4
        with:
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages
        run: yarn build:quick
        working-directory: next
      - name: Run tests
        run: yarn test ${{ matrix.package.cmd }}
        working-directory: next
    permissions:
      id-token: write
  jestTestsDdbOs:
    needs:
      - constants
      - build
    name: ${{ matrix.package.cmd }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
        node:
          - 20
        package: >-
          ${{ fromJson('[{"cmd":"packages/api-aco
          --storage=ddb-os,ddb","storage":"ddb-os","id":"e4b1b5ebc172f2657485e41c35ad1cd7"},{"cmd":"packages/api-audit-logs
          --storage=ddb-os,ddb","storage":"ddb-os","id":"b36aac5f0e34dc4583e5422ae589f1ed"},{"cmd":"packages/api-dynamodb-to-elasticsearch
          --storage=ddb-os,ddb","storage":["ddb-os"],"id":"6e0b282c3d135703e52b2c55822d4fb0"},{"cmd":"packages/api-elasticsearch","storage":["ddb-es","ddb-os"],"id":"430874606aeb8e8041b325955f9330e3"},{"cmd":"packages/api-elasticsearch-tasks
          --storage=ddb-os,ddb","storage":"ddb-os","id":"580a9577fdbd4a241034a42e1a47dee5"},{"cmd":"packages/api-file-manager
          --storage=ddb-os,ddb","storage":"ddb-os","id":"346430a79981d3e214c87254a08e31b2"},{"cmd":"packages/api-form-builder
          --storage=ddb-os,ddb","storage":"ddb-os","id":"d386cddfd3c366ad9955193dcfe74363"},{"cmd":"packages/api-form-builder-so-ddb-es
          --storage=ddb-os,ddb","storage":"ddb-os","id":"6086ced9d7b4412cc438b9e1aefbb976"},{"cmd":"packages/api-headless-cms
          --storage=ddb-os,ddb
          --shard=1/6","storage":"ddb-os","id":"f0851fe3b18a5f4130ae919506f9d68f"},{"cmd":"packages/api-headless-cms
          --storage=ddb-os,ddb
          --shard=2/6","storage":"ddb-os","id":"627bf598869494740bdb3ee340398ed5"},{"cmd":"packages/api-headless-cms
          --storage=ddb-os,ddb
          --shard=3/6","storage":"ddb-os","id":"49c59082ed1d7a79b742944965adff82"},{"cmd":"packages/api-headless-cms
          --storage=ddb-os,ddb
          --shard=4/6","storage":"ddb-os","id":"37865d8ba2366687e25fa61967fe4db9"},{"cmd":"packages/api-headless-cms
          --storage=ddb-os,ddb
          --shard=5/6","storage":"ddb-os","id":"19d0191a992c0a5145674dc0b37d96b6"},{"cmd":"packages/api-headless-cms
          --storage=ddb-os,ddb
          --shard=6/6","storage":"ddb-os","id":"2aade1f8261eacc7d93cc25fa3457fac"},{"cmd":"packages/api-headless-cms-aco
          --storage=ddb-os,ddb","storage":"ddb-os","id":"aa2c8429c2564549a680db23fe963347"},{"cmd":"packages/api-headless-cms-bulk-actions
          --storage=ddb-os,ddb","storage":"ddb-os","id":"a798b4705a7eb9858a51d80b386cf30a"},{"cmd":"packages/api-headless-cms-ddb-es
          --storage=ddb-os,ddb","storage":"ddb-os","id":"23bea783bb40390ae069dfa4985f97d2"},{"cmd":"packages/api-headless-cms-es-tasks
          --storage=ddb-os,ddb","storage":["ddb-os"],"id":"ee446fd78ad6294bbfb3c0689ff2602e"},{"cmd":"packages/api-headless-cms-import-export
          --storage=ddb-os,ddb","storage":"ddb-os","id":"6059cf3e78f93525c8ed72ad83b7de1a"},{"cmd":"packages/api-mailer
          --storage=ddb-os,ddb","storage":"ddb-os","id":"0ede859b604febdfa78018cdd1067a77"},{"cmd":"packages/api-page-builder
          --storage=ddb-os,ddb
          --shard=1/6","storage":"ddb-os","id":"691427cc9c5cb297c68cb2f90d7fcb89"},{"cmd":"packages/api-page-builder
          --storage=ddb-os,ddb
          --shard=2/6","storage":"ddb-os","id":"66b65733ec32b2010df792151240cca1"},{"cmd":"packages/api-page-builder
          --storage=ddb-os,ddb
          --shard=3/6","storage":"ddb-os","id":"8cdd1f181701f25f8cf9c3fe45b661bd"},{"cmd":"packages/api-page-builder
          --storage=ddb-os,ddb
          --shard=4/6","storage":"ddb-os","id":"0956377c7a7550c745e9402b51bdca85"},{"cmd":"packages/api-page-builder
          --storage=ddb-os,ddb
          --shard=5/6","storage":"ddb-os","id":"cc194759ab43627005bc21ee7c833a01"},{"cmd":"packages/api-page-builder
          --storage=ddb-os,ddb
          --shard=6/6","storage":"ddb-os","id":"b979f8aa837353847942b60e8f4bc057"},{"cmd":"packages/api-page-builder-aco
          --storage=ddb-os,ddb","storage":"ddb-os","id":"a1a7c90d43da1678f254bd4331cf4d55"},{"cmd":"packages/api-page-builder-so-ddb-es
          --storage=ddb-os,ddb","storage":"ddb-os","id":"e0236755edb31fc1a6005eb161941bf8"},{"cmd":"packages/api-serverless-cms
          --storage=ddb-os,ddb","storage":"ddb-os","id":"28f2386bb4be699710cb574f3401d76b"},{"cmd":"packages/migrations","storage":["ddb-es","ddb-os"],"id":"bd6345274042973682dcf9af2706627d"},{"cmd":"packages/tasks
          --storage=ddb-os,ddb","storage":"ddb-os","id":"5eadfa5cc14ec4e8ba87ac3dfb112580"}]')
          }}
    runs-on: ${{ matrix.os }}
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: false
      AWS_REGION: eu-central-1
      AWS_ELASTIC_SEARCH_DOMAIN_NAME: ${{ secrets.AWS_OPEN_SEARCH_DOMAIN_NAME }}
      ELASTIC_SEARCH_ENDPOINT: ${{ secrets.OPEN_SEARCH_ENDPOINT }}
      ELASTIC_SEARCH_INDEX_PREFIX: ${{ matrix.package.id }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::726952677045:role/GitHubActionsWebinyJs
          aws-region: eu-central-1
      - uses: actions/checkout@v4
        with:
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages
        run: yarn build:quick
        working-directory: next
      - name: Run tests
        run: yarn test ${{ matrix.package.cmd }}
        working-directory: next
    permissions:
      id-token: write
  e2eTestsDdb-constants:
    name: Constants - DDB
    needs:
      - build
    outputs:
      cypress-folders: ${{ steps.list-cypress-folders.outputs.cypress-folders }}
      pulumi-backend-url: ${{ steps.pulumi-backend-url.outputs.pulumi-backend-url }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
      - name: List Cypress tests folders
        id: list-cypress-folders
        run: >-
          echo "cypress-folders=$(node scripts/listCypressTestsFolders.js)" >>
          $GITHUB_OUTPUT
      - name: Get Pulumi backend URL
        id: get-pulumi-backend-url
        run: >-
          echo "pulumi-backend-url=${{ secrets.WEBINY_PULUMI_BACKEND }}${{
          github.run_id }}_ddb" >> $GITHUB_OUTPUT
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: false
  e2eTestsDdb-setup:
    needs:
      - constants
      - build
      - e2eTestsDdb-constants
    name: E2E (DDB) - Project setup
    outputs:
      cypress-config: ${{ steps.save-cypress-config.outputs.cypress-config }}
    environment: next
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: 'false'
      CYPRESS_MAILOSAUR_API_KEY: ${{ secrets.CYPRESS_MAILOSAUR_API_KEY }}
      PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
      PULUMI_SECRETS_PROVIDER: ${{ secrets.PULUMI_SECRETS_PROVIDER }}
      WEBINY_PULUMI_BACKEND: ${{ needs.e2eTestsDdb-constants.outputs.pulumi-backend-url }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::726952677045:role/GitHubActionsWebinyJs
          aws-region: eu-central-1
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages
        run: yarn build:quick
        working-directory: next
      - name: Start Verdaccio local server
        working-directory: next
        run: >-
          yarn add pm2 verdaccio && npx pm2 start verdaccio -- -c
          .verdaccio.yaml
      - name: Configure NPM to use local registry
        run: npm config set registry http://localhost:4873
      - name: Set git email
        run: git config --global user.email "webiny-bot@webiny.com"
      - name: Set git username
        run: git config --global user.name "webiny-bot"
      - name: Create ".npmrc" file in the project root, with a dummy auth token
        run: echo '//localhost:4873/:_authToken="dummy-auth-token"' > .npmrc
        working-directory: next
      - name: Version and publish to Verdaccio
        run: yarn release --type=verdaccio
        working-directory: next
      - name: Create verdaccio-files artifact
        uses: actions/upload-artifact@v4
        with:
          name: verdaccio-files-ddb
          retention-days: 1
          include-hidden-files: true
          path: |-
            next/.verdaccio/
            next/.verdaccio.yaml
      - name: Disable Webiny telemetry
        run: >
          mkdir ~/.webiny && echo '{ "id": "ci", "telemetry": false }' >
          ~/.webiny/config
      - name: Create a new Webiny project
        run: >
          npx create-webiny-project@local-npm new-webiny-project --tag local-npm
          --no-interactive --assign-to-yarnrc
          '{"npmRegistryServer":"http://localhost:4873","unsafeHttpWhitelist":["localhost"]}'
          --template-options
          '{"region":"eu-central-1","storageOperations":"ddb"}'
      - name: Print CLI version
        working-directory: new-webiny-project
        run: yarn webiny --version
      - name: Create project-files artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-files-ddb
          retention-days: 1
          include-hidden-files: true
          path: |-
            new-webiny-project/
            !new-webiny-project/node_modules/**/*
            !new-webiny-project/**/node_modules/**/*
            !new-webiny-project/.yarn/cache/**/*
      - name: Deploy Core
        working-directory: new-webiny-project
        run: yarn webiny deploy apps/core --env dev
      - name: Deploy API
        working-directory: new-webiny-project
        run: yarn webiny deploy apps/api --env dev
      - name: Deploy Admin Area
        working-directory: new-webiny-project
        run: yarn webiny deploy apps/admin --env dev
      - name: Deploy Website
        working-directory: new-webiny-project
        run: yarn webiny deploy apps/website --env dev
      - name: Create Cypress config
        run: yarn setup-cypress --projectFolder ../new-webiny-project
        working-directory: next
      - name: Save Cypress config
        id: save-cypress-config
        run: >-
          echo "cypress-config=$(cat cypress-tests/cypress.config.ts | tr -d
          '\t\n\r')" >> $GITHUB_OUTPUT
        working-directory: next
      - name: Cypress - run installation wizard test
        run: >-
          yarn cy:run --browser chrome --spec
          "cypress/e2e/adminInstallation/**/*.cy.js"
        working-directory: next
    runs-on: ubuntu-latest
    permissions:
      id-token: write
  e2eTestsDdb-cypress:
    name: >-
      ${{ matrix.cypress-folder }} (ddb, ${{ matrix.os }}, Node v${{ matrix.node
      }})
    needs:
      - constants
      - e2eTestsDdb-constants
      - e2eTestsDdb-setup
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
        node:
          - 20
        cypress-folder: ${{ fromJson(needs.e2eTestsDdb-constants.outputs.cypress-folders) }}
    environment: next
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: 'false'
      CYPRESS_MAILOSAUR_API_KEY: ${{ secrets.CYPRESS_MAILOSAUR_API_KEY }}
      PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
      PULUMI_SECRETS_PROVIDER: ${{ secrets.PULUMI_SECRETS_PROVIDER }}
      WEBINY_PULUMI_BACKEND: ${{ needs.e2eTestsDdb-constants.outputs.pulumi-backend-url }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
        with:
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages
        run: yarn build:quick
        working-directory: next
      - name: Set up Cypress config
        run: >-
          echo '${{ needs.e2eTestsDdb-setup.outputs.cypress-config }}' >
          cypress-tests/cypress.config.ts
        working-directory: next
      - name: Cypress - run "${{ matrix.cypress-folder }}" tests
        timeout-minutes: 40
        run: yarn cy:run --browser chrome --spec "${{ matrix.cypress-folder }}"
        working-directory: next
    runs-on: ubuntu-latest
  e2eTestsDdb-es-constants:
    name: Constants - DDB-ES
    needs:
      - build
    outputs:
      cypress-folders: ${{ steps.list-cypress-folders.outputs.cypress-folders }}
      pulumi-backend-url: ${{ steps.pulumi-backend-url.outputs.pulumi-backend-url }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
      - name: List Cypress tests folders
        id: list-cypress-folders
        run: >-
          echo "cypress-folders=$(node scripts/listCypressTestsFolders.js)" >>
          $GITHUB_OUTPUT
      - name: Get Pulumi backend URL
        id: get-pulumi-backend-url
        run: >-
          echo "pulumi-backend-url=${{ secrets.WEBINY_PULUMI_BACKEND }}${{
          github.run_id }}_ddb-es" >> $GITHUB_OUTPUT
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: false
  e2eTestsDdb-es-setup:
    needs:
      - constants
      - build
      - e2eTestsDdb-es-constants
    name: E2E (DDB-ES) - Project setup
    outputs:
      cypress-config: ${{ steps.save-cypress-config.outputs.cypress-config }}
    environment: next
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: 'false'
      CYPRESS_MAILOSAUR_API_KEY: ${{ secrets.CYPRESS_MAILOSAUR_API_KEY }}
      PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
      PULUMI_SECRETS_PROVIDER: ${{ secrets.PULUMI_SECRETS_PROVIDER }}
      WEBINY_PULUMI_BACKEND: ${{ needs.e2eTestsDdb-es-constants.outputs.pulumi-backend-url }}
      AWS_ELASTIC_SEARCH_DOMAIN_NAME: ${{ secrets.AWS_ELASTIC_SEARCH_DOMAIN_NAME }}
      ELASTIC_SEARCH_ENDPOINT: ${{ secrets.ELASTIC_SEARCH_ENDPOINT }}
      ELASTIC_SEARCH_INDEX_PREFIX: ${{ github.run_id }}_
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::726952677045:role/GitHubActionsWebinyJs
          aws-region: eu-central-1
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages
        run: yarn build:quick
        working-directory: next
      - name: Start Verdaccio local server
        working-directory: next
        run: >-
          yarn add pm2 verdaccio && npx pm2 start verdaccio -- -c
          .verdaccio.yaml
      - name: Configure NPM to use local registry
        run: npm config set registry http://localhost:4873
      - name: Set git email
        run: git config --global user.email "webiny-bot@webiny.com"
      - name: Set git username
        run: git config --global user.name "webiny-bot"
      - name: Create ".npmrc" file in the project root, with a dummy auth token
        run: echo '//localhost:4873/:_authToken="dummy-auth-token"' > .npmrc
        working-directory: next
      - name: Version and publish to Verdaccio
        run: yarn release --type=verdaccio
        working-directory: next
      - name: Create verdaccio-files artifact
        uses: actions/upload-artifact@v4
        with:
          name: verdaccio-files-ddb-es
          retention-days: 1
          include-hidden-files: true
          path: |-
            next/.verdaccio/
            next/.verdaccio.yaml
      - name: Disable Webiny telemetry
        run: >
          mkdir ~/.webiny && echo '{ "id": "ci", "telemetry": false }' >
          ~/.webiny/config
      - name: Create a new Webiny project
        run: >
          npx create-webiny-project@local-npm new-webiny-project --tag local-npm
          --no-interactive --assign-to-yarnrc
          '{"npmRegistryServer":"http://localhost:4873","unsafeHttpWhitelist":["localhost"]}'
          --template-options
          '{"region":"eu-central-1","storageOperations":"ddb-es"}'
      - name: Print CLI version
        working-directory: new-webiny-project
        run: yarn webiny --version
      - name: Create project-files artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-files-ddb-es
          retention-days: 1
          include-hidden-files: true
          path: |-
            new-webiny-project/
            !new-webiny-project/node_modules/**/*
            !new-webiny-project/**/node_modules/**/*
            !new-webiny-project/.yarn/cache/**/*
      - name: Deploy Core
        working-directory: new-webiny-project
        run: yarn webiny deploy apps/core --env dev
      - name: Deploy API
        working-directory: new-webiny-project
        run: yarn webiny deploy apps/api --env dev
      - name: Deploy Admin Area
        working-directory: new-webiny-project
        run: yarn webiny deploy apps/admin --env dev
      - name: Deploy Website
        working-directory: new-webiny-project
        run: yarn webiny deploy apps/website --env dev
      - name: Create Cypress config
        run: yarn setup-cypress --projectFolder ../new-webiny-project
        working-directory: next
      - name: Save Cypress config
        id: save-cypress-config
        run: >-
          echo "cypress-config=$(cat cypress-tests/cypress.config.ts | tr -d
          '\t\n\r')" >> $GITHUB_OUTPUT
        working-directory: next
      - name: Cypress - run installation wizard test
        run: >-
          yarn cy:run --browser chrome --spec
          "cypress/e2e/adminInstallation/**/*.cy.js"
        working-directory: next
    runs-on: ubuntu-latest
    permissions:
      id-token: write
  e2eTestsDdb-es-cypress:
    name: >-
      ${{ matrix.cypress-folder }} (ddb-es, ${{ matrix.os }}, Node v${{
      matrix.node }})
    needs:
      - constants
      - e2eTestsDdb-es-constants
      - e2eTestsDdb-es-setup
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
        node:
          - 20
        cypress-folder: >-
          ${{ fromJson(needs.e2eTestsDdb-es-constants.outputs.cypress-folders)
          }}
    environment: next
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: 'false'
      CYPRESS_MAILOSAUR_API_KEY: ${{ secrets.CYPRESS_MAILOSAUR_API_KEY }}
      PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
      PULUMI_SECRETS_PROVIDER: ${{ secrets.PULUMI_SECRETS_PROVIDER }}
      WEBINY_PULUMI_BACKEND: ${{ needs.e2eTestsDdb-es-constants.outputs.pulumi-backend-url }}
      AWS_ELASTIC_SEARCH_DOMAIN_NAME: ${{ secrets.AWS_ELASTIC_SEARCH_DOMAIN_NAME }}
      ELASTIC_SEARCH_ENDPOINT: ${{ secrets.ELASTIC_SEARCH_ENDPOINT }}
      ELASTIC_SEARCH_INDEX_PREFIX: ${{ github.run_id }}_
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
        with:
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages
        run: yarn build:quick
        working-directory: next
      - name: Set up Cypress config
        run: >-
          echo '${{ needs.e2eTestsDdb-es-setup.outputs.cypress-config }}' >
          cypress-tests/cypress.config.ts
        working-directory: next
      - name: Cypress - run "${{ matrix.cypress-folder }}" tests
        timeout-minutes: 40
        run: yarn cy:run --browser chrome --spec "${{ matrix.cypress-folder }}"
        working-directory: next
    runs-on: ubuntu-latest
  e2eTestsDdb-os-constants:
    name: Constants - DDB-OS
    needs:
      - build
    outputs:
      cypress-folders: ${{ steps.list-cypress-folders.outputs.cypress-folders }}
      pulumi-backend-url: ${{ steps.pulumi-backend-url.outputs.pulumi-backend-url }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
      - name: List Cypress tests folders
        id: list-cypress-folders
        run: >-
          echo "cypress-folders=$(node scripts/listCypressTestsFolders.js)" >>
          $GITHUB_OUTPUT
      - name: Get Pulumi backend URL
        id: get-pulumi-backend-url
        run: >-
          echo "pulumi-backend-url=${{ secrets.WEBINY_PULUMI_BACKEND }}${{
          github.run_id }}_ddb-os" >> $GITHUB_OUTPUT
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: false
  e2eTestsDdb-os-setup:
    needs:
      - constants
      - build
      - e2eTestsDdb-os-constants
    name: E2E (DDB-OS) - Project setup
    outputs:
      cypress-config: ${{ steps.save-cypress-config.outputs.cypress-config }}
    environment: next
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: 'false'
      CYPRESS_MAILOSAUR_API_KEY: ${{ secrets.CYPRESS_MAILOSAUR_API_KEY }}
      PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
      PULUMI_SECRETS_PROVIDER: ${{ secrets.PULUMI_SECRETS_PROVIDER }}
      WEBINY_PULUMI_BACKEND: ${{ needs.e2eTestsDdb-os-constants.outputs.pulumi-backend-url }}
      AWS_ELASTIC_SEARCH_DOMAIN_NAME: ${{ secrets.AWS_OPEN_SEARCH_DOMAIN_NAME }}
      ELASTIC_SEARCH_ENDPOINT: ${{ secrets.OPEN_SEARCH_ENDPOINT }}
      ELASTIC_SEARCH_INDEX_PREFIX: ${{ github.run_id }}_
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::726952677045:role/GitHubActionsWebinyJs
          aws-region: eu-central-1
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages
        run: yarn build:quick
        working-directory: next
      - name: Start Verdaccio local server
        working-directory: next
        run: >-
          yarn add pm2 verdaccio && npx pm2 start verdaccio -- -c
          .verdaccio.yaml
      - name: Configure NPM to use local registry
        run: npm config set registry http://localhost:4873
      - name: Set git email
        run: git config --global user.email "webiny-bot@webiny.com"
      - name: Set git username
        run: git config --global user.name "webiny-bot"
      - name: Create ".npmrc" file in the project root, with a dummy auth token
        run: echo '//localhost:4873/:_authToken="dummy-auth-token"' > .npmrc
        working-directory: next
      - name: Version and publish to Verdaccio
        run: yarn release --type=verdaccio
        working-directory: next
      - name: Create verdaccio-files artifact
        uses: actions/upload-artifact@v4
        with:
          name: verdaccio-files-ddb-os
          retention-days: 1
          include-hidden-files: true
          path: |-
            next/.verdaccio/
            next/.verdaccio.yaml
      - name: Disable Webiny telemetry
        run: >
          mkdir ~/.webiny && echo '{ "id": "ci", "telemetry": false }' >
          ~/.webiny/config
      - name: Create a new Webiny project
        run: >
          npx create-webiny-project@local-npm new-webiny-project --tag local-npm
          --no-interactive --assign-to-yarnrc
          '{"npmRegistryServer":"http://localhost:4873","unsafeHttpWhitelist":["localhost"]}'
          --template-options
          '{"region":"eu-central-1","storageOperations":"ddb-os"}'
      - name: Print CLI version
        working-directory: new-webiny-project
        run: yarn webiny --version
      - name: Create project-files artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-files-ddb-os
          retention-days: 1
          include-hidden-files: true
          path: |-
            new-webiny-project/
            !new-webiny-project/node_modules/**/*
            !new-webiny-project/**/node_modules/**/*
            !new-webiny-project/.yarn/cache/**/*
      - name: Deploy Core
        working-directory: new-webiny-project
        run: yarn webiny deploy apps/core --env dev
      - name: Deploy API
        working-directory: new-webiny-project
        run: yarn webiny deploy apps/api --env dev
      - name: Deploy Admin Area
        working-directory: new-webiny-project
        run: yarn webiny deploy apps/admin --env dev
      - name: Deploy Website
        working-directory: new-webiny-project
        run: yarn webiny deploy apps/website --env dev
      - name: Create Cypress config
        run: yarn setup-cypress --projectFolder ../new-webiny-project
        working-directory: next
      - name: Save Cypress config
        id: save-cypress-config
        run: >-
          echo "cypress-config=$(cat cypress-tests/cypress.config.ts | tr -d
          '\t\n\r')" >> $GITHUB_OUTPUT
        working-directory: next
      - name: Cypress - run installation wizard test
        run: >-
          yarn cy:run --browser chrome --spec
          "cypress/e2e/adminInstallation/**/*.cy.js"
        working-directory: next
    runs-on: ubuntu-latest
    permissions:
      id-token: write
  e2eTestsDdb-os-cypress:
    name: >-
      ${{ matrix.cypress-folder }} (ddb-os, ${{ matrix.os }}, Node v${{
      matrix.node }})
    needs:
      - constants
      - e2eTestsDdb-os-constants
      - e2eTestsDdb-os-setup
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
        node:
          - 20
        cypress-folder: >-
          ${{ fromJson(needs.e2eTestsDdb-os-constants.outputs.cypress-folders)
          }}
    environment: next
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: 'false'
      CYPRESS_MAILOSAUR_API_KEY: ${{ secrets.CYPRESS_MAILOSAUR_API_KEY }}
      PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
      PULUMI_SECRETS_PROVIDER: ${{ secrets.PULUMI_SECRETS_PROVIDER }}
      WEBINY_PULUMI_BACKEND: ${{ needs.e2eTestsDdb-os-constants.outputs.pulumi-backend-url }}
      AWS_ELASTIC_SEARCH_DOMAIN_NAME: ${{ secrets.AWS_OPEN_SEARCH_DOMAIN_NAME }}
      ELASTIC_SEARCH_ENDPOINT: ${{ secrets.OPEN_SEARCH_ENDPOINT }}
      ELASTIC_SEARCH_INDEX_PREFIX: ${{ github.run_id }}_
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
        with:
          path: next
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages
        run: yarn build:quick
        working-directory: next
      - name: Set up Cypress config
        run: >-
          echo '${{ needs.e2eTestsDdb-os-setup.outputs.cypress-config }}' >
          cypress-tests/cypress.config.ts
        working-directory: next
      - name: Cypress - run "${{ matrix.cypress-folder }}" tests
        timeout-minutes: 40
        run: yarn cy:run --browser chrome --spec "${{ matrix.cypress-folder }}"
        working-directory: next
    runs-on: ubuntu-latest
  npmReleaseUnstable:
    needs:
      - constants
      - codeAnalysis
      - jestTestsNoStorage
      - jestTestsDdb
      - jestTestsDdbEs
      - jestTestsDdbOs
      - e2eTestsDdb-cypress
      - e2eTestsDdb-es-cypress
      - e2eTestsDdb-os-cypress
    name: NPM release ("unstable" tag)
    environment: release
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      YARN_ENABLE_IMMUTABLE_INSTALLS: false
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/cache@v4
        with:
          path: next/.yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - uses: actions/cache@v4
        with:
          path: next/.webiny/cached-packages
          key: ${{ needs.constants.outputs.run-cache-key }}
      - name: Install dependencies
        run: yarn --immutable
        working-directory: next
      - name: Build packages
        run: yarn build:quick
        working-directory: next
      - name: Create ".npmrc" file in the project root
        run: echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > .npmrc
        working-directory: next
      - name: Set git info
        run: |
          git config --global user.email "webiny-bot@webiny.com"
          git config --global user.name "webiny-bot"
        working-directory: next
      - name: Version and publish to NPM
        run: yarn release --type=unstable
        working-directory: next
    runs-on: ubuntu-latest
